{"version":3,"file":"pageview.js","sources":["../src/version.ts","../../api/dist/api.js","../src/utils/path.ts","../src/utils/config.ts","../src/utils/error.ts","../src/utils/query.ts","../src/pageview.ts"],"sourcesContent":["declare const VERSION: string;\n\nexport const version = VERSION;\n","const d={\"Content-Type\":\"application/json\"},i=e=>`${e.replace(/\\/?$/,\"/\")}api/`,c=(e,n=\"\")=>{if(typeof e==\"object\"&&e.errno)throw new TypeError(`${n} failed with ${e.errno}: ${e.errmsg}`);return e},m=({serverURL:e,lang:n,paths:o,type:a,signal:t})=>fetch(`${i(e)}article?path=${encodeURIComponent(o.join(\",\"))}&type=${encodeURIComponent(a.join(\",\"))}&lang=${n}`,{signal:t}).then(r=>r.json()).then(r=>c(r,\"Get counter\").data),p=({serverURL:e,lang:n,path:o,type:a,action:t})=>fetch(`${i(e)}article?lang=${n}`,{method:\"POST\",headers:d,body:JSON.stringify({path:o,type:a,action:t})}).then(r=>r.json()).then(r=>c(r,\"Update counter\").data),$=({serverURL:e,lang:n,path:o,page:a,pageSize:t,sortBy:r,signal:l,token:s})=>{const h={};return s&&(h.Authorization=`Bearer ${s}`),fetch(`${i(e)}comment?path=${encodeURIComponent(o)}&pageSize=${t}&page=${a}&lang=${n}&sortBy=${r}`,{signal:l,headers:h}).then(g=>g.json()).then(g=>c(g,\"Get comment data\").data)},u=({serverURL:e,lang:n,token:o,comment:a})=>{const t={\"Content-Type\":\"application/json\"};return o&&(t.Authorization=`Bearer ${o}`),fetch(`${i(e)}comment?lang=${n}`,{method:\"POST\",headers:t,body:JSON.stringify(a)}).then(r=>r.json())},y=({serverURL:e,lang:n,token:o,objectId:a})=>fetch(`${i(e)}comment/${a}?lang=${n}`,{method:\"DELETE\",headers:{Authorization:`Bearer ${o}`}}).then(t=>t.json()).then(t=>c(t,\"Delete comment\")),f=({serverURL:e,lang:n,token:o,objectId:a,comment:t})=>fetch(`${i(e)}comment/${a}?lang=${n}`,{method:\"PUT\",headers:{...d,Authorization:`Bearer ${o}`},body:JSON.stringify(t)}).then(r=>r.json()).then(r=>c(r,\"Update comment\")),U=({serverURL:e,lang:n,paths:o,signal:a})=>fetch(`${i(e)}comment?type=count&url=${encodeURIComponent(o.join(\",\"))}&lang=${n}`,{signal:a}).then(t=>t.json()).then(t=>c(t,\"Get comment count\").data),R=()=>{const e=navigator.userAgent;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)},w=({lang:e,serverURL:n})=>{const o=(window.innerWidth-450)/2,a=(window.innerHeight-450)/2;if(R())return location.href=`${n.replace(/\\/$/,\"\")}/ui/login?lng=${encodeURIComponent(e)}&redirect=${encodeURIComponent(location.href)}`,new Promise(()=>{});const t=window.open(`${n.replace(/\\/$/,\"\")}/ui/login?lng=${encodeURIComponent(e)}`,\"_blank\",`width=450,height=450,left=${o},top=${a},scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no`);return t?.postMessage({type:\"TOKEN\",data:null},\"*\"),new Promise(r=>{const l=({data:s})=>{!s||typeof s!=\"object\"||s.type!==\"userInfo\"||s.data.token&&(t?.close(),window.removeEventListener(\"message\",l),r(s.data))};window.addEventListener(\"message\",l)})},C=({serverURL:e,lang:n,paths:o,signal:a})=>m({serverURL:e,lang:n,paths:o,type:[\"time\"],signal:a}),j=e=>p({...e,type:\"time\",action:\"inc\"}),v=({serverURL:e,lang:n,count:o,signal:a,token:t})=>{const r={};return t&&(r.Authorization=`Bearer ${t}`),fetch(`${i(e)}comment?type=recent&count=${o}&lang=${n}`,{signal:a,headers:r}).then(l=>l.json())},L=({serverURL:e,signal:n,pageSize:o,lang:a})=>fetch(`${i(e)}user?pageSize=${o}&lang=${a}`,{signal:n}).then(t=>t.json()).then(t=>c(t,\"user list\")).then(t=>t.data);export{u as addComment,y as deleteComment,U as fetchCommentCount,m as getArticleCounter,$ as getComment,C as getPageview,v as getRecentComment,L as getUserList,w as login,p as updateArticleCounter,f as updateComment,j as updatePageview};\n//# sourceMappingURL=api.js.map\n","export const decodePath = (path: string): string => {\n  try {\n    return decodeURI(path);\n  } catch {\n    return path;\n  }\n};\n\nexport const removeEndingSplash = (content = ''): string => content.replace(/\\/$/u, '');\n\nexport const isLinkHttp = (link: string): boolean => /^(https?:)?\\/\\//.test(link);\n","import { decodePath, isLinkHttp, removeEndingSplash } from './path.js';\nimport {\n  DEFAULT_EMOJI,\n  DEFAULT_REACTION,\n  defaultHighlighter,\n  defaultTeXRenderer,\n  defaultUploadImage,\n  getDefaultSearchOptions,\n  getLang,\n  getLocale,\n  getMeta,\n} from '../config/index.js';\nimport type {\n  WalineEmojiInfo,\n  WalineEmojiMaps,\n  WalineEmojiPresets,\n  WalineHighlighter,\n  WalineImageUploader,\n  WalineLocale,\n  WalineProps,\n  WalineSearchOptions,\n  WalineTeXRenderer,\n} from '../typings/index.js';\n\nexport interface WalineEmojiConfig {\n  tabs: Pick<WalineEmojiInfo, 'name' | 'icon' | 'items'>[];\n  map: WalineEmojiMaps;\n}\n\nexport interface WalineConfig extends Required<\n  Omit<\n    WalineProps,\n    'emoji' | 'imageUploader' | 'highlighter' | 'texRenderer' | 'wordLimit' | 'reaction' | 'search'\n  >\n> {\n  locale: WalineLocale;\n  wordLimit: [number, number] | false;\n  emoji: (WalineEmojiInfo | WalineEmojiPresets)[] | null;\n  highlighter: WalineHighlighter | null;\n  imageUploader: WalineImageUploader | null;\n  texRenderer: WalineTeXRenderer | null;\n  search: WalineSearchOptions | null;\n  reaction: string[] | null;\n}\n\nexport const getServerURL = (serverURL: string): string => {\n  const result = removeEndingSplash(serverURL);\n\n  return isLinkHttp(result) ? result : `https://${result}`;\n};\n\nconst getWordLimit = (wordLimit: WalineProps['wordLimit']): [number, number] | false =>\n  Array.isArray(wordLimit) ? wordLimit : typeof wordLimit === 'number' ? [0, wordLimit] : false;\n\nconst fallback = <T = unknown>(value: T | boolean | undefined, fallback: T): T | null =>\n  value == null || value === true ? fallback : value === false ? null : value;\n\nexport const getConfig = ({\n  serverURL,\n  path = location.pathname,\n  lang = typeof navigator === 'undefined' ? 'en-US' : navigator.language,\n  locale,\n  meta = ['nick', 'mail', 'link'],\n  requiredMeta = [],\n  dark = false,\n  pageSize = 10,\n  wordLimit,\n  noCopyright = false,\n  noRss = false,\n  login = 'enable',\n  recaptchaV3Key = '',\n  turnstileKey = '',\n  commentSorting = 'latest',\n  emoji = DEFAULT_EMOJI,\n  imageUploader,\n  highlighter,\n  texRenderer,\n  search,\n  reaction,\n  ...more\n}: WalineProps): WalineConfig => ({\n  serverURL: getServerURL(serverURL),\n  path: decodePath(path),\n  lang: getLang(lang),\n  locale: {\n    ...getLocale(getLang(lang)),\n    ...(typeof locale === 'object' ? locale : {}),\n  } as WalineLocale,\n  wordLimit: getWordLimit(wordLimit),\n  meta: getMeta(meta),\n  requiredMeta: getMeta(requiredMeta),\n  dark,\n  pageSize,\n  commentSorting,\n  login,\n  noCopyright,\n  noRss,\n  recaptchaV3Key,\n  turnstileKey,\n  ...more,\n  // oxlint-disable-next-line typescript/strict-boolean-expressions, typescript/prefer-nullish-coalescing\n  reaction: reaction === true ? DEFAULT_REACTION : reaction || null,\n  imageUploader: fallback(imageUploader, defaultUploadImage),\n  highlighter: fallback(highlighter, defaultHighlighter),\n  texRenderer: fallback(texRenderer, defaultTeXRenderer),\n  emoji: fallback(emoji, DEFAULT_EMOJI),\n  search: fallback(search, getDefaultSearchOptions(lang)),\n});\n","export const errorHandler = (err: Error): void => {\n  // oxlint-disable-next-line no-console\n  if (err.name !== 'AbortError') console.error(err.message);\n};\n","export const getQuery = (element: HTMLElement): string | null => {\n  const { path } = element.dataset;\n\n  // oxlint-disable-next-line typescript/strict-boolean-expressions\n  return path?.length ? path : null;\n};\n","import type { GetArticleCounterResponse } from '@waline/api';\nimport { getPageview, updatePageview } from '@waline/api';\n\nimport type { WalineAbort } from './typings/index.js';\nimport { errorHandler, getQuery, getServerURL } from './utils/index.js';\n\nexport interface WalinePageviewCountOptions {\n  /**\n   * Waline 服务端地址\n   *\n   * Waline server url\n   */\n  serverURL: string;\n\n  /**\n   * 浏览量 CSS 选择器\n   *\n   * Pageview CSS selector\n   *\n   * @default '.waline-pageview-count'\n   */\n  selector?: string;\n\n  /**\n   * 需要更新和获取的路径\n   *\n   * Path to be fetched and updated\n   *\n   * @default window.location.pathname\n   */\n  path?: string;\n\n  /**\n   * 是否在查询时更新 path 的浏览量\n   *\n   * Whether update pageviews when fetching path result\n   *\n   * @default true\n   */\n  update?: boolean;\n\n  /**\n   * 错误提示消息所使用的语言\n   *\n   * Language of error message\n   *\n   * @default navigator.language\n   */\n  lang?: string;\n}\n\nconst renderVisitorCount = (\n  counts: GetArticleCounterResponse,\n  countElements: HTMLElement[],\n): void => {\n  countElements.forEach((element, index) => {\n    const count = counts[index].time;\n\n    if (typeof count !== 'number') {\n      return;\n    }\n\n    element.textContent = count.toString();\n  });\n};\n\nexport const pageviewCount = ({\n  serverURL,\n  path = window.location.pathname,\n  selector = '.waline-pageview-count',\n  update = true,\n  lang = navigator.language,\n}: WalinePageviewCountOptions): WalineAbort => {\n  const controller = new AbortController();\n\n  const elements = [...document.querySelectorAll<HTMLElement>(selector)];\n\n  const filter = (element: HTMLElement): boolean => {\n    const query = getQuery(element);\n\n    return query != null && path !== query;\n  };\n\n  const fetch = (elements: HTMLElement[]): Promise<void> =>\n    getPageview({\n      serverURL: getServerURL(serverURL),\n      paths: elements.map((element) => getQuery(element) ?? path),\n      lang,\n      signal: controller.signal,\n    })\n      .then((counts) => {\n        renderVisitorCount(counts, elements);\n      })\n      .catch(errorHandler);\n\n  // we should update pageviews\n  if (update) {\n    const normalElements = elements.filter((element) => !filter(element));\n    const elementsNeedstoBeFetched = elements.filter((element) => filter(element));\n\n    void updatePageview({\n      serverURL: getServerURL(serverURL),\n      path,\n      lang,\n    }).then((counts) => {\n      renderVisitorCount(counts, normalElements);\n    });\n\n    // if we should fetch count of other pages\n    if (elementsNeedstoBeFetched.length > 0) {\n      void fetch(elementsNeedstoBeFetched);\n    }\n  }\n  // we should not update pageviews\n  else {\n    void fetch(elements);\n  }\n\n  return controller.abort.bind(controller);\n};\n"],"names":["version","d","i","c","n","m","o","a","t","r","p","C","j","removeEndingSplash","content","isLinkHttp","link","getServerURL","serverURL","result","errorHandler","err","getQuery","element","path","renderVisitorCount","counts","countElements","index","count","pageviewCount","selector","update","lang","controller","elements","filter","query","fetch","getPageview","normalElements","elementsNeedstoBeFetched","updatePageview"],"mappings":"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"}